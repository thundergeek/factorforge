<!DOCTYPE html>
<html>
<head>
    <title>FactorForge</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; }
        .header { background: #2c3e50; color: white; padding: 20px; border-radius: 5px; margin-bottom: 20px; }
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .stat-card { background: white; padding: 15px; border-radius: 5px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); position: relative; }
        .stat-card.selectable { cursor: pointer; transition: transform 0.2s; }
        .stat-card.selectable:hover { transform: translateY(-2px); }
        .stat-card.selected { border: 3px solid #3498db; }
        .stat-card:hover .tooltip { opacity: 1; visibility: visible; }
        .tooltip { position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%); 
                   background: #333; color: white; padding: 8px 12px; border-radius: 4px; 
                   font-size: 12px; white-space: nowrap; opacity: 0; visibility: hidden; 
                   transition: opacity 0.3s; z-index: 1000; margin-bottom: 5px; }
        .tooltip::after { content: ''; position: absolute; top: 100%; left: 50%; 
                         transform: translateX(-50%); border: 5px solid transparent; 
                         border-top-color: #333; }
        .stat-label { font-size: 14px; color: #7f8c8d; margin-bottom: 5px; }
        .stat-value { font-size: 24px; font-weight: bold; color: #2c3e50; }
        .progress-bar { background: #ecf0f1; height: 8px; border-radius: 4px; margin-top: 10px; overflow: hidden; }
        .progress-fill { background: #3498db; height: 100%; transition: width 0.3s; }
        .controls { background: white; padding: 20px; border-radius: 5px; margin-bottom: 20px; }
        input, button { padding: 10px; margin: 5px; border-radius: 4px; border: 1px solid #ddd; }
        button { background: #3498db; color: white; border: none; cursor: pointer; }
        button:hover { background: #2980b9; }
        button.secondary { background: #95a5a6; }
        button.secondary:hover { background: #7f8c8d; }
        .results { background: white; padding: 20px; border-radius: 5px; }
        .gpu-controls { margin-top: 10px; padding: 10px; background: #ecf0f1; border-radius: 4px; }
        .checkbox-label { display: inline-flex; align-items: center; margin-right: 15px; cursor: pointer; }
        .checkbox-label input { margin-right: 5px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>⚒️ FactorForge</h1>
            <p>AI-driven factor discovery using local LLMs</p>
        </div>
        
        <div class="stats" id="stats"></div>
        
        <div class="gpu-controls" id="gpu-controls" style="display:none;">
            <strong>Select GPUs for Ollama:</strong>
            <div id="gpu-checkboxes" style="margin: 10px 0;"></div>
            <button onclick="applyGPUSelection()" class="secondary">Apply & Restart Ollama</button>
            <span id="gpu-status" style="margin-left: 10px; color: #27ae60;"></span>
        </div>
        
        <div class="controls">
            <h2>Configuration</h2>
            <input type="text" id="symbols" placeholder="Stock symbols (comma-separated)" 
                   value="AAPL,MSFT,GOOGL,AMZN,NVDA,TSLA,JPM,BAC,V,MA" style="width: 500px;">
            <input type="number" id="generations" placeholder="Generations" value="10" style="width: 100px;">
            <input type="number" id="population" placeholder="Population" value="20" style="width: 100px;">
            <button onclick="startEvolution()">Start Evolution</button>
        </div>
        
        <div class="results">
            <h2>Progress</h2>
            <div id="progress"></div>
        </div>
    </div>
    
    <script>
        let gpuData = [];
        
        function updateStats() {
            fetch('/api/system_stats')
                .then(r => r.json())
                .then(data => {
                    let html = '';
                    gpuData = data.gpus;
                    
                    // CPU
                    html += `<div class="stat-card">
                        <div class="tooltip">${data.cpu.name}</div>
                        <div class="stat-label">${data.cpu.short_name}</div>
                        <div class="stat-value">${data.cpu.utilization.toFixed(1)}%</div>
                        <div class="progress-bar"><div class="progress-fill" style="width: ${data.cpu.utilization}%"></div></div>
                    </div>`;
                    
                    // RAM
                    html += `<div class="stat-card">
                        <div class="tooltip">System Memory</div>
                        <div class="stat-label">RAM</div>
                        <div class="stat-value">${data.ram.used_gb}/${data.ram.total_gb} GB</div>
                        <div class="progress-bar"><div class="progress-fill" style="width: ${data.ram.percent}%"></div></div>
                    </div>`;
                    
                    // GPUs
                    data.gpus.forEach(gpu => {
                        html += `<div class="stat-card">
                            <div class="tooltip">${gpu.name} (GPU ${gpu.index})</div>
                            <div class="stat-label">${gpu.short_name}</div>
                            <div class="stat-value">${gpu.utilization.toFixed(1)}%</div>
                            <div class="progress-bar"><div class="progress-fill" style="width: ${gpu.utilization}%"></div></div>
                            <div style="font-size: 12px; color: #7f8c8d; margin-top: 5px;">
                                VRAM: ${gpu.vram_used.toFixed(1)}/${gpu.vram_total.toFixed(1)} GB
                            </div>
                        </div>`;
                    });
                    
                    document.getElementById('stats').innerHTML = html;
                    
                    // Show GPU controls if GPUs detected
                    if (data.gpus.length > 0) {
                        document.getElementById('gpu-controls').style.display = 'block';
                        updateGPUCheckboxes(data.gpus);
                    }
                });
        }
        
        function updateGPUCheckboxes(gpus) {
            let html = '';
            gpus.forEach(gpu => {
                html += `<label class="checkbox-label">
                    <input type="checkbox" value="${gpu.index}" checked> 
                    ${gpu.short_name} (GPU ${gpu.index})
                </label>`;
            });
            document.getElementById('gpu-checkboxes').innerHTML = html;
        }
        
        function applyGPUSelection() {
            const checkboxes = document.querySelectorAll('#gpu-checkboxes input[type="checkbox"]');
            const selectedGPUs = Array.from(checkboxes)
                .filter(cb => cb.checked)
                .map(cb => parseInt(cb.value));
            
            if (selectedGPUs.length === 0) {
                alert('Please select at least one GPU, or select none to use CPU only');
            }
            
            document.getElementById('gpu-status').textContent = 'Restarting...';
            
            fetch('/api/set_gpus', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({gpu_indices: selectedGPUs})
            })
            .then(r => r.json())
            .then(data => {
                document.getElementById('gpu-status').textContent = data.message;
                setTimeout(() => {
                    document.getElementById('gpu-status').textContent = '';
                }, 3000);
            })
            .catch(err => {
                document.getElementById('gpu-status').textContent = 'Error: ' + err;
                document.getElementById('gpu-status').style.color = '#e74c3c';
            });
        }
        
        function startEvolution() {
            const symbols = document.getElementById('symbols').value.split(',').map(s => s.trim());
            const generations = parseInt(document.getElementById('generations').value);
            const population = parseInt(document.getElementById('population').value);
            
            fetch('/api/start_evolution', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({symbols, generations, population})
            }).then(() => alert('Evolution started!'));
        }
        
        setInterval(updateStats, 2000);
        updateStats();
    </script>
</body>
</html>
